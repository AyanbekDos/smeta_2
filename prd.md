# Product Requirements Document (PRD): Telegram-бот для обработки спецификаций

**Версия:** 1.1
**Дата:** 29.07.2025
**Владелец документа:** Product Manager

---

## 1. Введение

Этот документ описывает требования к продукту (PRD) для асинхронного Telegram-бота, предназначенного для автоматизации процесса извлечения данных из PDF-документов со спецификациями металлопроката. Проект направлен на значительное сокращение времени ручной обработки документов и минимизацию ошибок.

## 2. Проблема

В настоящее время инженеры, менеджеры по снабжению и другие специалисты тратят значительное количество времени на ручной поиск и извлечение данных из многостраничных PDF-документов со спецификациями. Этот процесс не только трудоемок, но и подвержен человеческим ошибкам, что может приводить к неверным заказам и финансовым потерям. Существующий рабочий процесс неэффективен и требует автоматизации.

## 3. Цели и задачи

*   **Основная цель:** Создать Telegram-бота, который автоматизирует процесс извлечения данных из PDF-спецификаций металлопроката.
*   **Задачи:**
    *   Сократить время обработки одного документа до нескольких минут.
    *   Повысить точность извлекаемых данных за счет использования OCR и AI.
    *   Упростить доступ к данным, предоставляя их в структурированных форматах (`.xlsx`, `.txt`).
    *   Обеспечить интуитивно понятный интерфейс взаимодействия через Telegram.

## 4. Целевая аудитория

*   **Инженеры-конструкторы:** Используют спецификации для проектирования.
*   **Менеджеры по закупкам и снабжению:** Используют данные для формирования заказов.
*   **Сметчики:** Используют данные для расчета стоимости проектов.

## 5. Пользовательский сценарий (Workflow)

Основной сценарий взаимодействия пользователя с ботом выглядит следующим образом:

1.  **Начало работы:** Пользователь инициирует диалог с ботом командой `/start`.
2.  **Загрузка документа:** Бот предлагает пользователю загрузить PDF-файл. Пользователь отправляет документ.
3.  **Первичная валидация:** Бот проверяет имя файла и первую страницу на наличие ключевого слова "КМД". Если "КМД" найдено, бот уведомляет пользователя, что такие документы не обрабатываются, и завершает сессию.
4.  **Автоматический поиск таблицы:** Если документ не "КМД", бот с помощью AI (Gemini) анализирует PDF и находит номер страницы, содержащей основную спецификацию.
5.  **Подтверждение страницы:** Бот отправляет пользователю изображение (PNG) найденной страницы и запрашивает подтверждение с помощью кнопок "Да" и "Нет".
6.  **Обработка ответа:**
    *   **"Да":** Бот переходит к следующему шагу.
    *   **"Нет":** Бот просит пользователя вручную ввести корректный номер страницы.
7.  **Извлечение данных:** После подтверждения страницы бот использует Azure OCR для распознавания текста, а затем передает его AI (Gemini) для структурирования и извлечения данных в иерархический JSON согласно требованиям в разделе 8.
8.  **Генерация отчетов:** На основе полученного JSON бот создает два отчета:
    *   Табличный файл `.xlsx`.
    *   Текстовый файл `.txt`.
9.  **Отправка результатов:** Бот отправляет пользователю текстовое превью извлеченных данных, а затем прикрепляет файлы `.xlsx` и `.txt`.
10. **Завершение:** Бот сообщает об успешном завершении обработки и удаляет временные файлы.

## 6. Функциональные требования

| ID | Требование | Описание | Приоритет |
|----|------------|----------|-----------|
| F-01 | Команда /start | Бот должен реагировать на команду `/start`, отправляя приветственное сообщение и инструкцию по работе. | Высокий |
| F-02 | Загрузка PDF | Бот должен принимать от пользователя файлы в формате PDF. | Высокий |
| F-03 | Валидация "КМД" | Бот должен проверять PDF на наличие "КМД" и прекращать обработку в случае его нахождения. | Высокий |
| F-04 | AI-поиск страницы | Бот должен использовать модель Gemini для автоматического определения номера страницы со спецификацией. | Высокий |
| F-05 | Подтверждение через PNG и кнопки | Бот должен уметь конвертировать страницу PDF в PNG и отправлять ее с кнопками для подтверждения. | Высокий |
| F-06 | Ручной ввод страницы | Если автоматический поиск не устроил пользователя, бот должен предоставить возможность ввести номер страницы вручную. | Средний |
| F-07 | OCR и структурирование данных | Использование Azure OCR для распознавания и Gemini для извлечения данных в строго иерархический JSON согласно требованиям в разделе 8. | Высокий |
| F-08 | Генерация отчетов | Создание `.xlsx` и `.txt` файлов из структурированного JSON. Отчеты должны содержать "сплющенные" данные для удобства анализа. | Высокий |
| F-09 | Отправка отчетов | Бот должен отправлять пользователю текстовое превью и сгенерированные файлы. | Высокий |
| F-10 | Коррекция и нормализация данных | Бот должен применять правила для исправления ошибок OCR и стандартизации данных (марки стали, размеры) согласно требованиям в разделе 8.2. | Высокий |

## 7. Нефункциональные требования

| ID | Требование | Описание |
|------|-----------------|-------------|
| NF-01 | Производительность | Бот должен быть асинхронным и отзывчивым, чтобы обрабатывать запросы от нескольких пользователей одновременно. |
| NF-02 | Обработка в памяти | Генерация файлов должна происходить в `BytesIO` для минимизации дисковых операций и ускорения работы. |
| NF-03 | Безопасность | Все API-ключи (Telegram, Gemini, Azure) должны храниться в `.env` файле и не должны быть доступны в коде. |
| NF-04 | Очистка ресурсов | Временные файлы (загруженный PDF) должны автоматически удаляться после завершения сессии обработки. |
| NF-05 | Тестируемость | Код должен быть покрыт тестами с использованием `pytest`. |

## 8. Требования к данным и их обработке

Этот раздел определяет ключевые правила для извлечения и структурирования данных, что является ядром функциональности бота.

### 8.1. Формат выходных данных (JSON)

Данные, извлеченные из спецификации, **должны** быть представлены в виде строго иерархического JSON-объекта. Плоские списки профилей недопустимы.

**Структура:**
```json
{
  "единица_измерения": "т",
  "профили": {
    "Название профиля (e.g., Двутавры...)": {
      "марки_стали": {
        "Марка стали (e.g., С355)": {
          "размеры": {
            "Размер профиля (e.g., 40К1)": {
              "элементы": {
                "Назначение (e.g., Стойки, колонны)": {
                  "позиции": ["1", "5", "12"],
                  "масса": 63.53
                }
              }
            }
          }
        }
      }
    }
  }
}
```
**Ключевые правила формата:**
- `"профили"`: это объект (словарь), где ключи — названия профилей.
- **Иерархия**: `профиль` → `марка_стали` → `размер` → `элемент`.
- **Группировка**: Позиции с одинаковым профилем, маркой, размером и элементом собираются вместе. Их номера (`поз`) объединяются в массив `"позиции"`.
- **Масса**: Указывается для каждой уникальной группы. Суммирование масс не производится.

### 8.2. Правила обработки и нормализации данных

- **Обязательные поля**: Поле `"размер"` является обязательным для заполнения. Если его невозможно извлечь, запись считается невалидной.
- **Единица измерения**: Система должна определить единицу измерения массы ("т", "кг") из таблицы и указать ее в поле `"единица_измерения"`.
- **Игнорирование итогов**: Строки, содержащие "Итого", "Всего" и подобные, должны быть проигнорированы.
- **Коррекция ошибок OCR**: Система должна автоматически исправлять распространенные ошибки распознавания:
    - `[16n` → `16п`
    - `[200` → `200`
    - `C247` → `24У`
    - `+5` → `s5`
    - `W` → `Ш` (в названиях балок, например, `I35W1` → `I35Ш1`)
    - `6` → `Б` (в названиях балок, например, `I2561` → `I25Б1`)
- **Стандартизация марок стали**:
    - Латиница исправляется на кириллицу (`C245` → `С245`).
    - Лишние суффиксы удаляются (`С245-РТ` → `С245`).
    - Распространенные ошибки исправляются (`Ст5` → `Ст3`).
    - Если марка стали указана для группы профилей, она применяется ко всем профилям в этой группе.

### 8.3. Генерация отчетов

- **"Сплющивание" данных**: Для генерации отчетов `.xlsx` и `.txt` иерархическая структура JSON преобразуется в плоскую таблицу. Каждая конечная запись (узел с массой) становится отдельной строкой в таблице.
- **Столбцы отчета**: Таблица должна содержать столбцы: `Наименование профиля`, `Марка стали`, `Размер профиля`, `Тип элемента`, `Позиции`, `Масса`.

## 9. Ключевые технологии

*   **Язык программирования:** Python
*   **Библиотека для Telegram:** `python-telegram-bot`
*   **AI для анализа и извлечения:** Google Gemini
*   **Сервис OCR:** Azure AI Document Intelligence
*   **Работа с данными:** pandas
*   **Конфигурация:** python-dotenv
*   **Тестирование:** pytest

## 10. Критерии успеха

*   **Сокращение времени:** Время обработки одного документа сокращено на 90% по сравнению с ручным трудом.
*   **Точность:** Точность извлечения данных составляет не менее 98% благодаря автоматической коррекции и строгой структуре.
*   **Принятие пользователями:** Бот активно используется целевой аудиторией, количество обработанных документов растет.
*   **Стабильность:** Uptime бота составляет 99.9%.