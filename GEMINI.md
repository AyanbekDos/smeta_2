
# Контекст проекта для Gemini

## 1. Цель проекта

Создание асинхронного Telegram-бота на `python-telegram-bot` для автоматизации обработки PDF-документов со спецификациями металлопроката.

## 2. Основной рабочий процесс (Workflow)

1.  **Старт**: Пользователь отправляет команду `/start`.
2.  **Загрузка PDF**: Бот принимает PDF-файл.
3.  **Валидация "КМД"**: Проверяется имя файла и текст на первой странице. При нахождении "КМД" обработка останавливается.
4.  **Поиск страницы (Gemini)**: PDF анализируется моделью Gemini с промптом из `find_table.txt` для нахождения номера страницы со спецификацией.
5.  **Подтверждение пользователем**: Бот отправляет PNG-изображение найденной страницы и кнопки "Да/Нет". Если пользователь нажимает "Нет", бот запрашивает номер страницы вручную.
6.  **OCR и структурирование (Azure + Gemini)**: Подтвержденная страница распознается через Azure OCR, и сырой текст отправляется в Gemini с промптом из `2_extract_details.txt` для извлечения данных в строго иерархический JSON.
7.  **Генерация отчетов**: Из JSON создается "плоский" pandas DataFrame, на основе которого генерируются файлы `.xlsx` и `.txt`.
8.  **Отправка результатов**: Пользователю отправляется текстовое превью, а затем файлы `.xlsx` и `.txt`.

## 3. Ключевые технологии и файлы

*   **Основной скрипт**: `main_bot.py` (содержит всю логику бота).
*   **Управление диалогом**: `ConversationHandler` из `python-telegram-bot`.
*   **Зависимости**: `requirements.txt` (устанавливаются в виртуальное окружение `venv/`).
*   **Конфигурация**: `.env` файл для хранения API-ключей (Telegram, Gemini, Azure).
*   **Промпты для Gemini**:
    *   `find_table.txt`: Поиск номера страницы.
    *   `2_extract_details.txt`: Извлечение и структурирование данных из текста OCR.
*   **Тестирование**: `pytest`, тесты в файлах `test_*.py`.

## 4. Важные нюансы

*   **Асинхронность**: Весь код в `main_bot.py` асинхронный (`async`/`await`).
*   **Обработка в памяти**: Файлы (PNG, XLSX, TXT) генерируются в `BytesIO` в оперативной памяти, чтобы избежать лишних операций с диском.
*   **Очистка**: Загруженный PDF-файл удаляется из временной папки `temp_bot_files/` после завершения обработки.
