# Архитектурный документ: Telegram-бот для обработки спецификаций

**Версия:** 1.0
**Дата:** 29.07.2025
**Автор:** Уинстон, Архитектор

---

## 1. Введение

### 1.1. Цель документа
Этот документ описывает архитектуру системы для Telegram-бота, предназначенного для автоматической обработки PDF-спецификаций металлопроката. Архитектура спроектирована на основе требований, изложенных в **Product Requirements Document (PRD) v1.1**.

### 1.2. Архитектурные принципы
В основе проекта лежат следующие ключевые принципы:
- **Модульность и разделение ответственности (SoC):** Система разделена на логические компоненты, каждый из которых отвечает за свою часть бизнес-логики.
- **Управляемость данными:** Поток данных является центральным элементом архитектуры, обеспечивая предсказуемую и надежную обработку.
- **Асинхронность:** Для обеспечения высокой производительности и отзывчивости при взаимодействии с внешними API и пользователями используется асинхронная модель.
- **Безопасность:** Конфиденциальные данные, такие как API-ключи, изолированы от кода и управляются через переменные окружения.
- **Обработка в памяти:** Для минимизации операций ввода-вывода и ускорения работы, промежуточные артефакты (изображения, отчеты) генерируются в памяти.

## 2. Обзор системы

### 2.1. Контекстная диаграмма (C4 Model, Level 1)
Система состоит из самого Telegram-бота, который взаимодействует с пользователем и тремя внешними сервисами.

```mermaid
graph TD
    subgraph "Система обработки спецификаций"
        A[Telegram-бот]
    end

    U[Пользователь] -- "Отправляет PDF, подтверждает страницу" --> A
    A -- "Отправляет PNG, отчеты (XLSX, TXT)" --> U

    A -- "1. Поиск страницы со спецификацией" --> G[Google Gemini API]
    A -- "2. Распознавание текста (OCR)" --> AZ[Azure AI Document Intelligence API]
    G -- "Возвращает номер страницы" --> A
    AZ -- "Возвращает распознанный текст" --> A
    A -- "3. Структурирование данных в JSON" --> G

    T[Telegram API]
    U -- "Взаимодействует через клиент" --> T
    T -- "Получает и отправляет сообщения" <--> A

    style G fill:#4285F4,stroke:#333,stroke-width:2px,color:#fff
    style AZ fill:#0078D4,stroke:#333,stroke-width:2px,color:#fff
    style T fill:#26A5E4,stroke:#333,stroke-width:2px,color:#fff
```

## 3. Компонентная архитектура (C4 Model, Level 2)

Внутренняя структура бота разделена на несколько логических компонентов, работающих согласованно в рамках единого асинхронного процесса.

```mermaid
graph TD
    subgraph "Telegram-бот"
        direction LR
        Handler[Bot Interface & Conversation]
        Processor[Document Processing Service]
        AI[AI Integration Service]
        Reporter[Report Generation Service]
        Storage[Temp Storage Manager]
    end

    Handler -- "PDF, UserInput" --> Processor
    Processor -- "Найти страницу (PDF)" --> AI
    Processor -- "Распознать текст (PNG)" --> AI
    AI -- "Номер страницы" --> Processor
    AI -- "Структурированный JSON" --> Reporter
    Processor -- "Удалить временный файл" --> Storage
    Reporter -- "Отчеты (BytesIO)" --> Handler

    style AI fill:#f9f,stroke:#333,stroke-width:2px
```

### 3.1. Описание компонентов

- **Bot Interface & Conversation (`ConversationHandler`)**:
  - **Ответственность:** Управление диалогом с пользователем, обработка команд (`/start`), прием файлов, отправка сообщений, изображений и сгенерированных отчетов. Является точкой входа и выхода для всех взаимодействий.
  - **Технологии:** `python-telegram-bot`.

- **Document Processing Service**:
  - **Ответственность:** Оркестрация основного рабочего процесса. Валидация PDF на "КМД", координация поиска страницы, запрос на OCR и структурирование, управление жизненным циклом временных файлов.
  - **Технологии:** Основная логика на Python.

- **AI Integration Service**:
  - **Ответственность:** Инкапсуляция всех вызовов к внешним AI-сервисам. Предоставляет простые методы для остальной части приложения (например, `find_page_in_pdf`, `extract_data_from_text`). Управляет аутентификацией и обработкой ответов от API.
  - **Технологии:** `google-generativeai`, `azure-ai-documentintelligence`.

- **Report Generation Service**:
  - **Ответственность:** Преобразование иерархического JSON, полученного от AI, в "плоскую" структуру данных. Генерация на ее основе отчетов в форматах `.xlsx` и `.txt`.
  - **Технологии:** `pandas`, `openpyxl`, `io.BytesIO`.

- **Temp Storage Manager**:
  - **Ответственность:** Управление временным хранением загруженного PDF-файла. Обеспечивает сохранение файла на диск для анализа и его последующее удаление после завершения обработки для соблюдения чистоты и безопасности.
  - **Технологии:** `os`, `tempfile`.

## 4. Технологический стек

| Компонент | Технология | Обоснование |
|---|---|---|
| Язык | Python 3.10+ | Отличная поддержка асинхронности и зрелая экосистема библиотек для AI/ML и веб. |
| Telegram API | `python-telegram-bot` | Мощная, гибкая и широко используемая библиотека для создания ботов с поддержкой `asyncio`. |
| AI (Анализ) | Google Gemini API | Высокая производительность и мультимодальные возможности для анализа PDF. |
| AI (OCR) | Azure AI Document Intelligence | Лидирующее в отрасли решение для точного распознавания текста. |
| Работа с PDF | `pypdf`, `Pillow` | Чисто Python-решение для извлечения страниц и конвертации в изображения без внешних зависимостей. |
| Работа с данными | `pandas` | Стандарт де-факто для манипуляции данными и создания табличных отчетов (`.xlsx`). |
| Конфигурация | `python-dotenv` | Простой и надежный способ управления секретами и конфигурацией через `.env` файлы. |
| Тестирование | `pytest` | Гибкий и мощный фреймворк для написания тестов. |

## 5. Поток данных (Data Flow)

Диаграмма последовательности, иллюстрирующая полный цикл обработки запроса.

```mermaid
sequenceDiagram
    participant U as Пользователь
    participant B as Бот
    participant G as Gemini API
    participant AZ as Azure OCR

    U->>B: /start
    B-->>U: "Загрузите PDF"
    U->>B: Отправляет PDF-файл
    B->>B: Валидация "КМД"
    B-->>U: "Идет поиск таблицы..."
    B->>G: Запрос на поиск страницы (с PDF)
    G-->>B: Возвращает номер страницы
    B->>B: Конвертирует страницу в PNG
    B-->>U: Отправляет PNG и кнопки "Да/Нет"
    U->>B: Нажимает "Да"
    B-->>U: "Начинаю распознавание..."
    B->>AZ: Запрос на OCR (с PNG)
    AZ-->>B: Возвращает сырой текст
    B->>G: Запрос на структурирование (с текстом)
    G-->>B: Возвращает иерархический JSON
    B->>B: "Сплющивает" JSON и генерирует отчеты (XLSX, TXT)
    B-->>U: Отправляет текстовое превью
    B-->>U: Отправляет XLSX и TXT файлы
    B->>B: Удаляет временный PDF
```

## 6. Модель данных

Ключевой структурой данных в системе является иерархический JSON, который генерирует Gemini. Эта структура является источником истины для всех последующих отчетов.

**Пример структуры (сокращенно):**
```json
{
  "единица_измерения": "т",
  "профили": {
    "Двутавры ...": {
      "марки_стали": {
        "С355": {
          "размеры": {
            "40К1": {
              "элементы": {
                "Стойки, колонны": {
                  "позиции": ["1"],
                  "масса": 63.53
                }
              }
            }
          }
        }
      }
    }
  }
}
```

## 7. Безопасность

- **Управление API-ключами:** Все ключи (Telegram, Gemini, Azure) хранятся в файле `.env` и загружаются в переменные окружения при старте. Они не должны быть зафиксированы в системе контроля версий.
- **Обработка временных файлов:** Загруженный пользователем PDF-файл сохраняется во временную директорию и гарантированно удаляется после завершения сеанса обработки, чтобы избежать утечки данных.
- **Данные пользователя:** Бот не хранит историю запросов или персональные данные пользователей. Каждый сеанс обработки является атомарным.

## 8. Развертывание и эксплуатация

- **Зависимости:** Все необходимые Python-библиотеки перечислены в файле `requirements.txt` и должны быть установлены в виртуальное окружение (`venv`).
- **Запуск:** Бот запускается как единый процесс Python (`python main_bot.py`), который поддерживает постоянное соединение с Telegram API.
- **Масштабируемость:** Благодаря асинхронной архитектуре, бот способен эффективно обрабатывать запросы от нескольких пользователей одновременно. Основным ограничивающим фактором будет производительность внешних API (Gemini, Azure). В случае роста нагрузки, можно рассмотреть переход к модели с несколькими воркерами, однако для текущих целей это не требуется.
